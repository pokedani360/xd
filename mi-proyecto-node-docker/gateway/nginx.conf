worker_processes 1;

events { worker_connections 1024; }

http {
  include       mime.types;
  default_type  application/octet-stream;

  sendfile on;
  keepalive_timeout 65;
  client_max_body_size 10m;

  # ===== CORS centralizado (solo Nginx) =====
  map $http_origin $cors_origin {
    default "";
    "~^https?://localhost:3000$" $http_origin;  # agrega orígenes si necesitas
  }

  # ===== Upstreams estáticos (evitan 'resolver' en runtime) =====
  upstream auth_service           { server auth-service:5001; }
  upstream preguntas_service      { server preguntas-service:5002; }
  upstream ensayos_service        { server ensayos-service:5003; }
  upstream resultados_service     { server resultados-service:5004; }
  upstream materias_service       { server materias-service:5005; }
  upstream respuestas_service     { server respuestas-service:5006; }
  upstream colegios_cursos_service{ server colegios-cursos-service:5007; }  # <— IMPORTANTE

  server {
    listen 80;

    # Encabezados proxy
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header Cookie $http_cookie;

    # Oculta cualquier CORS que envíen los microservicios
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;
    proxy_hide_header Access-Control-Expose-Headers;
    proxy_hide_header Access-Control-Max-Age;
    proxy_hide_header Access-Control-Allow-Credentials;

    # CORS (solo desde Nginx)
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Vary Origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-Auth-Token, Origin, Accept" always;
    add_header Access-Control-Expose-Headers "Content-Length, Content-Range" always;
    add_header Access-Control-Max-Age 1728000 always;

    if ($request_method = OPTIONS) { return 204; }

    # ===== Servicios “clásicos” =====
    location /api/ensayos/     { proxy_pass http://ensayos-service:5003/; }
    location /api/resultados/  { proxy_pass http://resultados-service:5004/; }
    location /api/materias/    { proxy_pass http://materias-service:5005/; }
    location /api/preguntas/   { proxy_pass http://preguntas-service:5002/; }
    location /api/respuestas/  { proxy_pass http://respuestas-service:5006/; }
    location /api/auth/       { proxy_pass http://auth-service:5001/; }

    # ===== Colegios/Cursos: el micro YA usa /api → NO reescribir
    # Usa upstream estático para evitar 'resolver' en runtime
    location ^~ /api/colegios       { proxy_pass http://colegios_cursos_service; }
    location ^~ /api/cursos         { proxy_pass http://colegios_cursos_service; }
    location ^~ /api/mi             { proxy_pass http://colegios_cursos_service; }
    location ^~ /api/curso_miembros { proxy_pass http://colegios_cursos_service; }
  }
}