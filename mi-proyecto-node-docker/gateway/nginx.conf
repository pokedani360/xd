# Configuración principal de Nginx
worker_processes 1;

events {
    worker_connections 1024;
}

http {
    # Habilitar MIME types predeterminados
    include       mime.types;
    default_type  application/octet-stream;

    # Definir los servidores upstream (tus microservicios)
    # Los nombres deben coincidir con los service names en docker-compose.yml
    upstream materias_service {
        server materias-service:5005;
    }
    upstream respuestas_service {
        server respuestas-service:5006;
    }
    upstream auth_service {
        server auth-service:5001;
    }
    upstream preguntas_service {
        server preguntas-service:5002;
    }
    upstream ensayos_service {
        server ensayos-service:5003;
    }
    upstream resultados_service {
        server resultados-service:5004;
    }

    # Bloque del servidor HTTP (escucha en el puerto 80 del gateway)
    server {
        listen 80;

        # Configuración para habilitar CORS (Cross-Origin Resource Sharing)
        # Esto es crucial para que tu frontend (localhost:3000) pueda hacer peticiones
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
        add_header 'Access-Control-Max-Age' 1728000 always; # Este ya está fuera del 'if'

        # Manejo de solicitudes OPTIONS (preflight requests de CORS)
        if ($request_method = 'OPTIONS') {
            # Se eliminaron los 'add_header' de aquí. Nginx se encargará con el 'default_type'
            # y los encabezados CORS ya definidos en el bloque 'server'.
            return 204; # No Content
        }

        # Rutas de proxy a los microservicios
        location /api/auth/ {
            proxy_pass http://auth_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/preguntas/ {
            proxy_pass http://preguntas_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/ensayos/ {
            proxy_pass http://ensayos_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/resultados/ {
            proxy_pass http://resultados_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/materias/ {
            proxy_pass http://materias_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/respuestas/ {
            proxy_pass http://respuestas_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
